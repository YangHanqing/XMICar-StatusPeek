#!name=XMICar-StatusPeek
#!desc=ç›‘å¬è®¢å•çŠ¶æ€ç ï¼Œè‡ªåŠ¨æ¨é€ä¸‹çº¿ã€è¿å‡ºç­‰çŠ¶æ€é€šçŸ¥ ğŸš—
#!author=hqyang
#!version=1.0.0
#!update=2025-08-06T09:00+08:00

[Script]
# è°ƒè¯•ç‰ˆ - ä½¿ç”¨ http-request æµ‹è¯•
XMICar-OrderStatus-Req = type=http-request, requires-body=0, \
pattern=^https:\/\/api\.retail\.xiaomiev\.com\/mtop\/carlife\/product\/order.*$, \
script-path=inline, tag=XMICarè¯·æ±‚è°ƒè¯•

#!script
(() => {
  console.log("ğŸ” [XMICar-Request] æ•è·åˆ°è¯·æ±‚:", $request.url);
  $notification.post("ğŸ” è¯·æ±‚è°ƒè¯•", "æ•è·åˆ°è¯·æ±‚", $request.url);
  $done();
})();

# è°ƒè¯•ç‰ˆ - http-response
XMICar-OrderStatus-Resp = type=http-response, requires-body=1, \
pattern=^https:\/\/api\.retail\.xiaomiev\.com\/mtop\/carlife\/product\/order.*$, \
max-size=10240, timeout=10, script-path=inline, tag=XMICarå“åº”è°ƒè¯•

#!script
(() => {
  console.log("ğŸ” [XMICar-Response] æ•è·åˆ°å“åº”");
  
  // ç«‹å³å‘é€è°ƒè¯•é€šçŸ¥
  $notification.post("ğŸ” å“åº”è°ƒè¯•", "æ•è·åˆ°å“åº”", "å¼€å§‹å¤„ç†å“åº”æ•°æ®");
  
  if (!$response?.body) {
    console.log("âŒ [XMICar-Response] æ— å“åº”ä½“");
    $notification.post("âŒ è°ƒè¯•", "æ— å“åº”ä½“", "æ£€æŸ¥æ¥å£æ˜¯å¦è¿”å›æ•°æ®");
    return $done();
  }

  console.log("ğŸ“Š [XMICar-Response] å“åº”ä½“:", $response.body.substring(0, 500));
  
  try {
    const obj = JSON.parse($response.body);
    const info = obj?.data?.orderDetailDto?.statusInfo;
    
    if (info) {
      const code = info.orderStatus;
      const name = info.orderStatusName;
      
      $notification.post(
        "ğŸš— å°ç±³æ±½è½¦çŠ¶æ€",
        `çŠ¶æ€ç : ${code}`,
        `${name}`
      );
    } else {
      $notification.post("âš ï¸ è°ƒè¯•", "æ‰¾ä¸åˆ°çŠ¶æ€ä¿¡æ¯", "æ£€æŸ¥æ•°æ®ç»“æ„");
    }
  } catch (e) {
    $notification.post("âŒ è°ƒè¯•", "è§£æå¤±è´¥", e.message);
  }

  $done($response);
})();

[Mitm]
hostname = api.retail.xiaomiev.com
