#!name=XMICar-StatusPeek
#!desc=ç›‘å¬å°ç±³æ±½è½¦è®¢å•æ¥å£ï¼Œæ¨é€ä¸‹çº¿/è¿å‡ºç­‰éšè—çŠ¶æ€
#!author=hqyang
#!version=1.0.0
#!update=2025-08-07T10:45+08:00

[Script]
# å°ç±³æ±½è½¦è®¢å•çŠ¶æ€ç›‘å¬
http-response ^https?:\/\/api\.retail\.xiaomiev\.com\/mtop\/carlife\/product\/order(\?.*)? \
script-path=inline, requires-body=true, max-size=0, tag=XMICar-è®¢å•çŠ¶æ€

#!script
(() => {
  /* ä»»ä½•æ—¥å¿—éƒ½ä¼šä»¥ warning ç­‰çº§è¾“å‡ºï¼Œæ–¹ä¾¿åœ¨é»˜è®¤æ—¥å¿—ç­‰çº§ä¸‹æŸ¥çœ‹ */
  const warn = (...args) => console.warn('[XMICar]', ...args);

  warn('âš ï¸ è„šæœ¬è§¦å‘');

  if (!$response?.body) {
    warn('âš ï¸ æ— å“åº”ä½“ï¼Œç»“æŸ');
    return $done();
  }

  let info;
  try {
    const obj = JSON.parse($response.body);
    info = obj?.data?.orderDetailDto?.statusInfo;
  } catch (e) {
    warn('âŒ JSON è§£æå¤±è´¥:', e);
  }

  if (!info) {
    warn('âš ï¸ æœªæ‰¾åˆ° statusInfo');
    return $done($response);
  }

  const code = info.orderStatus;
  const name = info.orderStatusName;
  const map  = {
    2520: 'è½¦è¾†å°šæœªä¸‹çº¿',
    2605: 'è½¦è¾†å·²ä¸‹çº¿',
    3000: 'è½¦è¾†å·²è¿å‡º'
  };
  const desc = map[code] || 'çŠ¶æ€æœªçŸ¥ï¼Œç•™æ„å˜åŠ¨';

  $notification.post('ğŸš— å°ç±³æ±½è½¦è®¢å•çŠ¶æ€', `çŠ¶æ€ç : ${code}`, `${name}\n${desc}`);
  warn(`âœ… å·²é€šçŸ¥: ${code} / ${name} / ${desc}`);

  $done($response);          // åŸæ ·æ”¾è¡Œï¼Œå®Œå…¨ä¸å½±å“ App
})();

[mitm]
hostname = api.retail.xiaomiev.com
