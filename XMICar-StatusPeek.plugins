#!name=XMICar-StatusPeek
#!desc=ç›‘å¬è®¢å•çŠ¶æ€ç ï¼Œè‡ªåŠ¨æ¨é€ä¸‹çº¿ã€è¿å‡ºç­‰çŠ¶æ€é€šçŸ¥ ğŸš—
#!author=hqyang

########################################
#               Script                 #
########################################
[Script]
# æ‹¦æˆªå°ç±³æ±½è½¦è®¢å•æ¥å£ï¼ˆPOST/GET å‡å¯ï¼‰ï¼Œè§£æçŠ¶æ€
XMICar-OrderStatus = type=http-response, requires-body=1, \
pattern=^https:\/\/api\.retail\.xiaomiev\.com\/mtop\/carlife\/product\/order(\?.*)?$, \
max-size=2048, timeout=8, script-path=inline

#!script
// XMICar Order Status â‡¢ Loon http-response
(() => {
  const log = (...args) => console.log("[XMICar]", ...args);

  if (!$response?.body) { log("æ— å“åº”ä½“"); return $done(); }

  try {
    const obj  = JSON.parse($response.body);
    const info = obj?.data?.orderDetailDto?.statusInfo;
    if (!info) { log("æœªæ‰¾åˆ° statusInfo"); return $done(); }

    const code = info.orderStatus;
    const name = info.orderStatusName;

    // çŠ¶æ€ç ç¿»è¯‘å­—å…¸
    const map = {
      2520: "è½¦è¾†å°šæœªä¸‹çº¿",
      2605: "è½¦è¾†å·²ä¸‹çº¿",
      3000: "è½¦è¾†å·²è¿å‡º"
    };
    const desc = map[code] || "çŠ¶æ€æœªçŸ¥ï¼Œç•™æ„å˜åŠ¨";

    // å‘é€ç³»ç»Ÿé€šçŸ¥
    $notification.post(
      "ğŸš— å°ç±³æ±½è½¦è®¢å•çŠ¶æ€",
      `çŠ¶æ€ç : ${code}`,
      `${name}\n${desc}`
    );

    log(`æ¨é€é€šçŸ¥ â†’ ${code} / ${name} / ${desc}`);
  } catch (e) {
    log("è§£æå¼‚å¸¸:", e);
  }

  // ä¸ä¿®æ”¹å“åº”ï¼Œç›´æ¥æ”¾è¡Œ
  $done($response);
})();

########################################
#                MITM                  #
########################################
[Mitm]
hostname = api.retail.xiaomiev.com
