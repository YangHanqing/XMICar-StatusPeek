#!name=XMICar-StatusPeek
#!desc=监听小米汽车订单接口，推送下线/运出等隐藏状态
#!author=hqyang
#!version=1.0.0
#!update=2025-08-07T10:45+08:00

[Script]
# 小米汽车订单状态监听
http-response ^https?:\/\/api\.retail\.xiaomiev\.com\/mtop\/carlife\/product\/order(\?.*)? \
script-path=inline, requires-body=true, max-size=0, tag=XMICar-订单状态

#!script
(() => {
  /* 任何日志都会以 warning 等级输出，方便在默认日志等级下查看 */
  const warn = (...args) => console.warn('[XMICar]', ...args);

  warn('⚠️ 脚本触发');

  if (!$response?.body) {
    warn('⚠️ 无响应体，结束');
    return $done();
  }

  let info;
  try {
    const obj = JSON.parse($response.body);
    info = obj?.data?.orderDetailDto?.statusInfo;
  } catch (e) {
    warn('❌ JSON 解析失败:', e);
  }

  if (!info) {
    warn('⚠️ 未找到 statusInfo');
    return $done($response);
  }

  const code = info.orderStatus;
  const name = info.orderStatusName;
  const map  = {
    2520: '车辆尚未下线',
    2605: '车辆已下线',
    3000: '车辆已运出'
  };
  const desc = map[code] || '状态未知，留意变动';

  $notification.post('🚗 小米汽车订单状态', `状态码: ${code}`, `${name}\n${desc}`);
  warn(`✅ 已通知: ${code} / ${name} / ${desc}`);

  $done($response);          // 原样放行，完全不影响 App
})();

[mitm]
hostname = api.retail.xiaomiev.com
